<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© ÙˆØ³Ø§Ù… XO - Ù†Ø³Ø®Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0b1120; --card: #1e293b; --primary: #38bdf8; --accent: #f43f5e; --success: #22c55e; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 450px; padding: 15px; text-align: center; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 15px; }
        .btn { width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .btn-blue { background: var(--primary); color: #000; }
        
        /* Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© */
        .share-box { background: rgba(56, 189, 248, 0.1); border: 1px dashed var(--primary); padding: 10px; border-radius: 12px; margin-bottom: 15px; font-size: 0.8rem; }
        .btn-copy { background: var(--primary); color: #000; border: none; padding: 5px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }

        .notebook-mode { background: #fff !important; border-right: 35px solid #fca5a5 !important; padding: 20px !important; color: #334155 !important; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px auto; max-width: 320px; }
        .cell { aspect-ratio: 1; background: #1e293b; border-radius: 12px; border: 1px solid #334155; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; height: 100px; position: relative; }
        .notebook-mode .cell { border: none !important; border-bottom: 2px solid #cbd5e1 !important; border-left: 2px solid #cbd5e1 !important; background: none; }
        
        #chat-section { background: var(--card); border-radius: 15px; padding: 12px; border: 1px solid #334155; }
        #messages { height: 100px; overflow-y: auto; text-align: right; margin-bottom: 10px; }
        .msg-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #334155; font-size: 0.8rem; }
        .del-btn { color: var(--accent); cursor: pointer; font-weight: bold; }
        
        .chat-controls { display: flex; gap: 5px; align-items: center; }
        .btn-reset-side { background: var(--success); color: white; border: none; border-radius: 10px; padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 10px; text-align: center; }
        canvas { position: absolute; width: 100%; height: 100%; pointer-events: none; }
    </style>
</head>
<body>
<div class="container">
    <div id="start-screen">
        <h2 style="color:var(--primary)">ğŸ® Ù…Ù†ØµØ© ÙˆØ³Ø§Ù…</h2>
        <div class="card">
            <input type="text" id="p-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
            <button class="btn btn-blue" onclick="join('Lobby', false)">Ù„Ø¹Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ğŸ²</button>
            <input type="text" id="r-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ… Ø§Ù„Ø®Ø§Øµ">
            <label><input type="checkbox" id="draw-check"> Ø·ÙˆØ± Ø§Ù„Ø¯ÙØªØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ğŸ““</label>
            <button class="btn btn-blue" style="background:none; border:2px solid var(--primary); color:var(--primary)" onclick="join(null, true)">Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ â•</button>
        </div>
    </div>

    <div id="game-area" style="display:none;">
        <div class="share-box" id="share-ui">
            <div>Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø¯Ø¹ÙˆØ©:</div>
            <div id="room-link-text" style="color:var(--primary); word-break: break-all; margin: 5px 0;"></div>
            <button class="btn-copy" onclick="copyRoomLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—</button>
        </div>

        <div id="status" class="card" style="font-weight:bold; color:var(--primary); font-size:1.1rem; padding:10px;">Ø§Ù†ØªØ¸Ø§Ø±..</div>
        
        <div class="grid" id="board"></div>

        <div id="chat-section">
            <div id="messages"></div>
            <div class="chat-controls">
                <button class="btn-reset-side" onclick="doReset()">Ø¥Ø¹Ø§Ø¯Ø© ğŸ”„</button>
                <input type="text" id="m-input" placeholder="Ø±Ø³Ø§Ù„Ø©.." style="margin:0; flex:1;">
                <button onclick="send()" style="background:var(--primary); border:none; border-radius:10px; padding:10px 15px; font-weight:bold;">OK</button>
            </div>
        </div>
        <button onclick="window.location.reload()" class="btn" style="background:var(--accent); margin-top:10px; font-size:0.9rem; padding:10px;">Ø®Ø±ÙˆØ¬ ğŸ </button>
    </div>
</div>

<script>
    const config = { databaseURL: "https://xoxo-af105-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(config);
    const db = firebase.database();
    let room = "", mySym = "", isNb = false, name = "";

    // ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ (Ù„Ùˆ Ø®ÙˆÙŠÙƒ Ø£Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·)
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        if(roomFromUrl) {
            document.getElementById('r-input').value = roomFromUrl;
        }
    };

    function join(id, isPriv) {
        name = document.getElementById('p-name').value || "Ù„Ø§Ø¹Ø¨";
        room = id || (document.getElementById('r-input').value || "999");
        isNb = document.getElementById('draw-check').checked;
        
        const ref = db.ref('rooms/' + room);
        ref.transaction(d => {
            if(!d) return { b: Array(9).fill(""), t: "X", pX: name, pO: "", nb: isNb };
            if(!d.pO && d.pX !== name) { d.pO = name; return d; }
            return undefined;
        }, (err, c, snap) => {
            const val = snap.val();
            mySym = val.pX === name ? 'X' : (val.pO === name ? 'O' : 'Ù…Ø´Ø§Ù‡Ø¯');
            init();
        });
    }

    function init() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const fullUrl = window.location.origin + window.location.pathname + "?room=" + room;
        document.getElementById('room-link-text').innerText = fullUrl;

        const bDiv = document.getElementById('board');
        if(isNb) { bDiv.classList.add('notebook-mode'); document.body.style.background = "#cbd5e1"; }
        bDiv.innerHTML = "";
        for(let i=0; i<9; i++) {
            let c = document.createElement('div');
            c.className = 'cell'; c.onclick = () => move(i);
            bDiv.appendChild(c);
        }
        sync();
    }

    function copyRoomLink() {
        const link = document.getElementById('room-link-text').innerText;
        navigator.clipboard.writeText(link);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„Ø®ÙˆÙŠÙƒ Ø§Ù„Ø­ÙŠÙ†.");
    }

    function sync() {
        db.ref('rooms/' + room).on('value', s => {
            const d = s.val(); if(!d) return;
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => {
                if(v === "") { cells[i].innerText = ""; if(cells[i].querySelector('canvas')) cells[i].querySelector('canvas').remove(); }
                else if(isNb && !cells[i].querySelector('canvas')) draw(cells[i], v);
                else if(!isNb) { cells[i].innerText = v; cells[i].style.color = v==='X'?'#fbbf24':'#f87171'; }
            });
            document.getElementById('status').innerText = d.win ? "Ø§Ù„ÙØ§Ø¦Ø²: " + d.win : (!d.b.includes("") ? "ØªØ¹Ø§Ø¯Ù„" : "Ø¯ÙˆØ±: " + d.t);
        });
        db.ref('chat/' + room).on('value', s => {
            const m = document.getElementById('messages'); m.innerHTML = "";
            s.forEach(c => { 
                m.innerHTML += `<div class="msg-item"><span><b>${c.val().n}:</b> ${c.val().t}</span><span class="del-btn" onclick="del('${c.key}')">ğŸ—‘ï¸</span></div>`; 
            });
            m.scrollTop = m.scrollHeight;
        });
    }

    function move(i) {
        const ref = db.ref('rooms/' + room);
        ref.once('value').then(s => {
            let d = s.val();
            if(d.win || d.b[i] !== "" || d.t !== mySym) return;
            d.b[i] = mySym; d.t = mySym === 'X' ? 'O' : 'X';
            const p = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let x of p) if(d.b[x[0]] && d.b[x[0]]===d.b[x[1]] && d.b[x[0]]===d.b[x[2]]) d.win = d.b[x[0]]==='X'?d.pX:d.pO;
            ref.set(d);
        });
    }

    function doReset() { 
        if(confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ")) {
            db.ref('rooms/' + room).update({ b: Array(9).fill(""), t: "X", win: null }); 
        }
    }

    function del(k) { db.ref('chat/' + room + '/' + k).remove(); }
    function send() { 
        let i = document.getElementById('m-input'); 
        if(i.value.trim()) { db.ref('chat/' + room).push({ n: name, t: i.value }); i.value = ""; } 
    }
    
    function draw(c, t) {
        const can = document.createElement('canvas'); c.appendChild(can);
        const ctx = can.getContext('2d'); can.width = 100; can.height = 100;
        ctx.strokeStyle = "#334155"; ctx.lineWidth = 6; ctx.lineCap = 'round';
        if(t==='X') { ctx.moveTo(25,25); ctx.lineTo(75,75); ctx.stroke(); ctx.moveTo(75,25); ctx.lineTo(25,75); ctx.stroke(); }
        else { ctx.beginPath(); ctx.arc(50,50,30,0,7); ctx.stroke(); }
    }
</script>
</body>
</html>
