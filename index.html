<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O WORLD ONLINE</title>
    <style>
        :root { --bg: #1a1a2e; --card: #16213e; --accent: #0f3460; --x-color: #e94560; --o-color: #4ecca3; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        .container { width: 100%; max-width: 400px; text-align: center; }
        
        #winMessage { display: none; background: var(--o-color); color: #1a1a2e; padding: 15px; border-radius: 12px; font-size: 1.5rem; font-weight: bold; margin: 10px 0; border: 3px solid white; }
        #status { background: var(--accent); padding: 12px; border-radius: 12px; margin: 10px 0; font-weight: bold; border: 2px solid #444; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: var(--accent); padding: 10px; border-radius: 15px; margin-bottom: 15px; }
        .cell { aspect-ratio: 1/1; background: var(--card); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; cursor: pointer; transition: 0.2s; font-weight: bold; min-height: 100px; }
        .cell.X { color: var(--x-color); }
        .cell.O { color: var(--o-color); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ø¬Ø¯Ø§Ù‹ */
        .chat-area { background: var(--card); border-radius: 15px; height: 280px; display: flex; flex-direction: column; border: 1px solid var(--accent); margin-top: 15px; position: relative; } /* Added relative for emoji-picker */
        #msgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-row { display: flex; align-items: center; gap: 8px; width: 100%; }
        .my-row { justify-content: flex-start; }
        .other-row { justify-content: flex-end; flex-direction: row-reverse; }

        .bubble { padding: 6px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 70%; word-wrap: break-word; }
        .my-bubble { background: var(--o-color); color: #1a1a2e; font-weight: bold; }
        .other-bubble { background: var(--accent); color: white; }
        .emoji-bubble { font-size: 2rem; padding: 0; background: none; box-shadow: none; max-width: 100px; } /* Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± */

        .del-btn { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 1.1rem; opacity: 0.7; transition: 0.3s; }
        .del-btn:hover { opacity: 1; transform: scale(1.2); }

        .input-box { display: flex; padding: 8px; background: var(--accent); border-radius: 0 0 15px 15px; }
        input { flex: 1; background: none; border: none; color: white; outline: none; padding: 5px; }
        .send-btn, .emoji-btn { background: var(--o-color); border: none; border-radius: 8px; padding: 5px 12px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .emoji-btn { margin-right: 0; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ */
        #emoji-picker {
            display: none;
            position: absolute;
            bottom: 60px; /* ÙÙˆÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
            left: 0;
            right: 0;
            background: #283a5e;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            max-height: 150px;
            overflow-y: auto;
        }
        #emoji-picker span {
            cursor: pointer;
            font-size: 1.8rem;
            padding: 5px;
            transition: transform 0.1s;
        }
        #emoji-picker span:hover { transform: scale(1.2); }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color: var(--o-color);">X-O Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸ®</h2>
        <div id="playerInfo" style="margin-bottom: 5px; color: #aaa;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        
        <div id="winMessage"></div>
        <div id="status">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø®ØµÙ…...</div>

        <div class="grid" id="board">
            <div class="cell" onclick="handlePlay(0)"></div>
            <div class="cell" onclick="handlePlay(1)"></div>
            <div class="cell" onclick="handlePlay(2)"></div>
            <div class="cell" onclick="handlePlay(3)"></div>
            <div class="cell" onclick="handlePlay(4)"></div>
            <div class="cell" onclick="handlePlay(5)"></div>
            <div class="cell" onclick="handlePlay(6)"></div>
            <div class="cell" onclick="handlePlay(7)"></div>
            <div class="cell" onclick="handlePlay(8)"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            
            <div id="emoji-picker"></div> <div class="input-box">
                <button class="emoji-btn" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
                <input type="text" id="chatInp" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="send-btn" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBopnQ0bLP60tuYXxlFUeKRfeesXDfz3MI",
            authDomain: "x-o2-fa961.firebaseapp.com",
            databaseURL: "https://x-o2-fa961-default-rtdb.firebaseio.com",
            projectId: "x-o2-fa961",
            appId: "1:19053737189:web:1ccd0671544318c4da900c"
        };

        firebase.initializeApp(firebaseConfig);
        const roomID = prompt("Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:", "1");
        const db = firebase.database().ref('rooms/' + roomID);
        
        let mySym = "";
        const clickSnd = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©
        db.child('players').transaction(p => p === null ? {p1:true} : (p.p2===undefined ? {p1:true,p2:true} : p), (err,com,snap) => {
            mySym = snap.val().p2 ? 'O' : 'X';
            document.getElementById('playerInfo').innerText = `Ø£Ù†Øª: ${mySym} | ØºØ±ÙØ©: ${roomID}`;
        });

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø¹Ø¨
        db.child('game').on('value', snap => {
            const data = snap.val() || {board: Array(9).fill(""), turn: 'X', status: 'playing'};
            document.querySelectorAll('.cell').forEach((c, i) => {
                c.innerText = data.board[i];
                c.className = `cell ${data.board[i]}`;
            });
            const st = document.getElementById('status');
            const win = document.getElementById('winMessage');
            if(data.status.startsWith('win')) {
                win.innerText = `Ù…Ø¨Ø±ÙˆÙƒ ÙÙˆØ² ${data.status.split('-')[1]}! ğŸ‰`;
                win.style.display = "block"; st.style.display = "none";
            } else {
                win.style.display = "none"; st.style.display = "block";
                st.innerText = data.turn === mySym ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!" : `Ø§Ù†ØªØ¸Ø± ${data.turn}...`;
            }
        });

        function handlePlay(i) {
            db.child('game').once('value', snap => {
                const d = snap.val() || {board: Array(9).fill(""), turn: 'X', status: 'playing'};
                if(d.board[i] === "" && d.turn === mySym && d.status === 'playing') {
                    clickSnd.play();
                    d.board[i] = mySym;
                    d.turn = mySym === 'X' ? 'O' : 'X';
                    db.child('game').update(d);
                    checkWinner(d.board);
                }
            });
        }

        function checkWinner(b) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let c of wins) if(b[c[0]] && b[c[0]]===b[c[1]] && b[c[0]]===b[c[2]]) db.child('game/status').set('win-'+b[c[0]]);
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ---
        const emojis = ["ğŸ˜€", "ğŸ˜‚", "ğŸ¤©", "ğŸ¤”", "ğŸ¥³", "ğŸ˜­", "ğŸ‘", "ğŸ‘", "â¤ï¸", "ğŸ”¥", "ğŸ’¯", "ğŸ¤¯", "ğŸ˜", "ğŸ’©", "ğŸ‘»", "ğŸ˜ˆ", "ğŸ˜´", "ğŸ¥¶", "ğŸ’¡", "ğŸš€"];
        
        function populateEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.innerText = emoji;
                span.onclick = () => sendEmoji(emoji);
                picker.appendChild(span);
            });
        }
        populateEmojiPicker(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„

        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' || picker.style.display === '' ? 'block' : 'none';
        }

        function sendEmoji(emoji) {
            clickSnd.play();
            db.child('chat').push({u: mySym, m: emoji, type: 'emoji'});
            toggleEmojiPicker(); // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        }

        function sendMsg() {
            const inp = document.getElementById('chatInp');
            if(inp.value.trim()) {
                clickSnd.play();
                db.child('chat').push({u: mySym, m: inp.value, type: 'text'});
                inp.value = "";
            }
        }

        db.child('chat').on('value', snap => {
            const box = document.getElementById('msgs');
            box.innerHTML = "";
            snap.forEach(s => {
                const d = s.val();
                const isMe = d.u === mySym;
                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'my-row' : 'other-row'}`;
                
                let contentHTML = '';
                if (d.type === 'emoji') {
                    contentHTML = `<div class="bubble emoji-bubble">${d.m}</div>`;
                } else {
                    contentHTML = `<div class="bubble ${isMe ? 'my-bubble' : 'other-bubble'}">${d.u}: ${d.m}</div>`;
                }

                row.innerHTML = `
                    ${contentHTML}
                    ${isMe ? `<button class="del-btn" onclick="delMsg('${s.key}')">ğŸ—‘ï¸</button>` : ""}
                `;
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;
        });

        function delMsg(key) {
            clickSnd.play();
            db.child('chat').child(key).remove();
        }
    </script>
</body>
</html>
