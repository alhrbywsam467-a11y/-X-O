<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O PRO ONLINE</title>
    <style>
        :root { --bg: #1a1a2e; --card: #16213e; --accent: #0f3460; --x-color: #e94560; --o-color: #4ecca3; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 400px; text-align: center; }
        #status { background: var(--accent); padding: 15px; border-radius: 12px; margin: 15px 0; font-weight: bold; border: 2px solid #444; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: var(--accent); padding: 10px; border-radius: 15px; }
        .cell { aspect-ratio: 1/1; background: var(--card); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; cursor: pointer; transition: 0.2s; font-weight: bold; min-height: 100px; }
        .cell.X { color: var(--x-color); }
        .cell.O { color: var(--o-color); }
        .info-bar { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; font-size: 0.9rem; color: #aaa; }
        button { width: 100%; margin-top: 20px; padding: 12px; background: var(--x-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color: var(--o-color);">Ù„Ø¹Ø¨Ø© X-O Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸ®</h2>
        <div class="info-bar">
            <span id="player-role">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø¯ÙˆØ±Ùƒ...</span>
            <span id="room-id-display"></span>
        </div>
        <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
        <div class="grid" id="board">
            <script>for(let i=0; i<9; i++) document.write(`<div class="cell" onclick="handlePlay(${i})"></div>`);</script>
        </div>
        <button onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBopnQ0bLP60tuYXxlFUeKRfeesXDfz3MI",
            authDomain: "x-o2-fa961.firebaseapp.com",
            databaseURL: "https://x-o2-fa961-default-rtdb.firebaseio.com",
            projectId: "x-o2-fa961",
            appId: "1:19053737189:web:1ccd0671544318c4da900c"
        };
        firebase.initializeApp(firebaseConfig);

        const roomID = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:", "1") || "1";
        document.getElementById('room-id-display').innerText = "ØºØ±ÙØ©: " + roomID;
        const db = firebase.database().ref('rooms/' + roomID);

        let mySym = ""; 

        // 1. Ù†Ø¸Ø§Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Transaction) Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± O
        db.child('players').transaction((currentData) => {
            if (currentData === null) {
                return { p1: "occupied", p2: null }; // Ø§Ù„Ø£ÙˆÙ„ ÙŠØ£Ø®Ø° p1
            } else if (currentData.p2 === null) {
                return { p1: "occupied", p2: "occupied" }; // Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠØ£Ø®Ø° p2
            }
            return currentData; // Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©
        }, (error, committed, snapshot) => {
            const data = snapshot.val();
            if (data.p2 === null) {
                mySym = "X";
            } else if (mySym === "") {
                mySym = "O";
            }
            document.getElementById('player-role').innerText = "Ø£Ù†Øª ØªÙ„Ø¹Ø¨ Ø¨Ù€: " + mySym;
        });

        // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        db.child('game').on('value', snap => {
            const data = snap.val() || { board: Array(9).fill(""), turn: "X" };
            const cells = document.querySelectorAll('.cell');
            data.board.forEach((val, i) => {
                cells[i].innerText = val;
                cells[i].className = `cell ${val}`;
            });
            
            document.getElementById('status').innerText = (data.turn === mySym) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!" : `Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ ${data.turn}`;
        });

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨
        function handlePlay(i) {
            db.child('game').once('value', snap => {
                const data = snap.val() || { board: Array(9).fill(""), turn: "X" };
                if (data.board[i] === "" && data.turn === mySym) {
                    data.board[i] = mySym;
                    data.turn = (mySym === "X") ? "O" : "X";
                    db.child('game').update(data);
                }
            });
        }

        // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨
        function resetGame() {
            db.child('game').set({ board: Array(9).fill(""), turn: "X" });
        }
    </script>
</body>
</html>
