<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø³Ø®Ø© ÙˆØ³Ø§Ù… - Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø­Ù‚ÙŠÙ‚ÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0b1120; --card: #1e293b; --x: #fbbf24; --o: #f43f5e; }
        body { font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        .status-box { background: var(--card); padding: 10px; border-radius: 12px; margin: 10px 0; border: 1px solid #334155; width: 280px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 300px; }
        .cell { width: 90px; height: 90px; background: var(--card); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; cursor: pointer; border: 1px solid #334155; }
        .X { color: var(--x); } .O { color: var(--o); }
        .chat-area { width: 300px; background: var(--card); border-radius: 15px; padding: 10px; margin-top: 15px; border: 1px solid #334155; }
        #msgs { height: 90px; overflow-y: auto; text-align: right; font-size: 0.8rem; margin-bottom: 8px; }
        .msg { background: rgba(0,0,0,0.3); padding: 5px; border-radius: 6px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .input-group { display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; }
        .btn-reset { background: #22c55e; color: white; padding: 12px; width: 300px; margin-top: 15px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <h2 style="color:var(--primary)">ğŸ® Ù…Ù†ØµØ© ÙˆØ³Ø§Ù…</h2>
    
    <div class="status-box">
        <div id="role-display" style="color: var(--primary); font-size: 0.9rem;">Ø£Ù†Øª: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div id="status-text" style="font-weight: bold; font-size: 1.2rem; margin-top: 5px;">Ø§Ù†ØªØ¸Ø§Ø±..</div>
    </div>

    <div class="grid" id="board">
        <div class="cell" onclick="play(0)"></div>
        <div class="cell" onclick="play(1)"></div>
        <div class="cell" onclick="play(2)"></div>
        <div class="cell" onclick="play(3)"></div>
        <div class="cell" onclick="play(4)"></div>
        <div class="cell" onclick="play(5)"></div>
        <div class="cell" onclick="play(6)"></div>
        <div class="cell" onclick="play(7)"></div>
        <div class="cell" onclick="play(8)"></div>
    </div>

    <button class="btn-reset" onclick="reboot()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ ğŸ”„</button>

    <div class="chat-area">
        <div id="msgs"></div>
        <div class="input-group">
            <input type="text" id="chat-in" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
            <button onclick="shout()" style="background:var(--primary); padding: 0 10px;">OK</button>
        </div>
    </div>

<script>
    const config = { databaseURL: "https://xoxo-af105-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(config);
    const database = firebase.database();
    const game = database.ref('match_v1');
    const chat = database.ref('chat_v1');

    let mySign = "";

    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± (X Ø£Ùˆ O)
    game.child('slots').transaction(s => {
        if(!s) return {X: true};
        if(!s.X) return {X: true, O: s.O};
        if(!s.O) return {X: true, O: true};
        return s;
    }, (err, ok, snap) => {
        const v = snap.val();
        mySign = !v.O ? "X" : (v.X && v.O && !mySign ? "O" : "Viewer");
        document.getElementById('role-display').innerText = "Ø£Ù†Øª: " + mySign;
    });

    // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© "Ù„Ø­Ø¸ÙŠØ§Ù‹"
    game.on('value', snap => {
        const d = snap.val();
        if(!d || !d.board) { reboot(); return; }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ø§Ù‹
        const cells = document.querySelectorAll('.cell');
        d.board.forEach((val, i) => {
            cells[i].innerText = val;
            cells[i].className = 'cell ' + (val || '');
        });

        // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        if(d.win) {
            document.getElementById('status-text').innerText = "Ø§Ù„ÙØ§Ø¦Ø²: " + d.win;
        } else if (!d.board.includes("")) {
            document.getElementById('status-text').innerText = "ØªØ¹Ø§Ø¯Ù„! ğŸ¤";
        } else {
            document.getElementById('status-text').innerText = "Ø¯ÙˆØ±: " + d.turn;
        }
    });

    // 3. Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
    function play(i) {
        game.once('value').then(snap => {
            const d = snap.val();
            if(!d || d.win || d.board[i] !== "" || d.turn !== mySign) return;
            
            d.board[i] = mySign;
            d.turn = (mySign === "X") ? "O" : "X";
            
            // ÙØ­Øµ Ø§Ù„ÙÙˆØ²
            const combo = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let c of combo) {
                if(d.board[c[0]] && d.board[c[0]]===d.board[c[1]] && d.board[c[0]]===d.board[c[2]]) d.win = d.board[c[0]];
            }
            game.set(d); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
        });
    }

    // 4. ØªØµÙÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„ÙƒÙ„
    function reboot() {
        game.update({ board: Array(9).fill(""), turn: "X", win: null });
    }

    // 5. Ø§Ù„Ø´Ø§Øª
    chat.on('value', snap => {
        const b = document.getElementById('msgs'); b.innerHTML = "";
        snap.forEach(m => {
            b.innerHTML += `<div class="msg"><span><b>${m.val().u}:</b> ${m.val().t}</span><span style="color:red;cursor:pointer" onclick="database.ref('chat_v1/${m.key}').remove()">ğŸ—‘ï¸</span></div>`;
        });
        b.scrollTop = b.scrollHeight;
    });

    function shout() {
        const i = document.getElementById('chat-in');
        if(i.value) { chat.push({u: mySign, t: i.value}); i.value = ""; }
    }
</script>
</body>
</html>
