<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O ÙˆØ³Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© + Ø´Ø§Øª</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --x-color: #fbbf24; --o-color: #f87171; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        #status { margin-bottom: 20px; font-size: 1.2rem; padding: 10px 25px; background: var(--card); border-radius: 50px; border: 1px solid #334155; }
        #player-identity { margin-bottom: 10px; color: var(--primary); font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(3, 90px); gap: 12px; }
        .cell { width: 90px; height: 90px; background: var(--card); border: 2px solid #334155; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .cell:hover { border-color: var(--primary); }
        .cell.X { color: var(--x-color); }
        .cell.O { color: var(--o-color); }
        .disabled { pointer-events: none; opacity: 0.7; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #chat-container { width: 100%; max-width: 300px; margin-top: 20px; background: var(--card); border-radius: 15px; border: 1px solid #334155; padding: 10px; }
        #messages { height: 120px; overflow-y: auto; text-align: right; margin-bottom: 10px; font-size: 0.9rem; padding: 5px; }
        .msg-item { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 5px 8px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #334155; }
        .del-msg { color: var(--o-color); cursor: pointer; font-weight: bold; font-size: 0.7rem; margin-right: 10px; }
        .chat-input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 8px; }
        
        button { background: var(--primary); color: var(--bg); border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .reset-btn { margin-top: 20px; padding: 12px 35px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <h1>ğŸ® Ù…Ù†ØµØ© ÙˆØ³Ø§Ù… Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨</h1>
    <div id="player-identity">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù‡ÙˆÙŠØªÙƒ...</div>
    <div id="status">Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...</div>
    
    <div class="grid" id="board">
        <div class="cell" onclick="makeMove(0)"></div>
        <div class="cell" onclick="makeMove(1)"></div>
        <div class="cell" onclick="makeMove(2)"></div>
        <div class="cell" onclick="makeMove(3)"></div>
        <div class="cell" onclick="makeMove(4)"></div>
        <div class="cell" onclick="makeMove(5)"></div>
        <div class="cell" onclick="makeMove(6)"></div>
        <div class="cell" onclick="makeMove(7)"></div>
        <div class="cell" onclick="makeMove(8)"></div>
    </div>

    <button class="reset-btn" onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ”„</button>

    <div id="chat-container">
        <div id="messages"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="win-sound" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script>
        const firebaseConfig = { databaseURL: "https://xoxo-af105-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const gameRef = db.ref('pro_game');
        const chatRef = db.ref('pro_chat');

        let myRole = null;

        gameRef.child('players').once('value').then((snap) => {
            let players = snap.val() || {};
            if (!players.X) {
                myRole = 'X';
                gameRef.child('players/X').set(true);
            } else if (!players.O) {
                myRole = 'O';
                gameRef.child('players/O').set(true);
            } else {
                myRole = 'Viewer';
            }
            document.getElementById('player-identity').innerText = "Ø£Ù†Øª ØªÙ„Ø¹Ø¨ Ø¨Ù€: " + myRole;
        });

        window.onbeforeunload = () => { if(myRole && myRole !== 'Viewer') gameRef.child('players/' + myRole).remove(); };

        gameRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !data.board) { resetGame(); return; }

            const cells = document.querySelectorAll('.cell');
            data.board.forEach((val, i) => {
                cells[i].innerText = val;
                cells[i].className = 'cell ' + (val ? val : '');
            });

            if (data.winner) {
                document.getElementById('status').innerText = data.winner === "Draw" ? "ØªØ¹Ø§Ø¯Ù„! ğŸ¤" : "Ø§Ù„ÙØ§Ø¦Ø²: " + data.winner;
                if(data.winner === myRole) document.getElementById('win-sound').play();
            } else {
                document.getElementById('status').innerText = "Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: " + data.turn;
                const boardElement = document.getElementById('board');
                if (data.turn !== myRole) boardElement.classList.add('disabled');
                else boardElement.classList.remove('disabled');
            }
        });

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Øª
        chatRef.on('value', (snap) => {
            const msgDiv = document.getElementById('messages');
            msgDiv.innerHTML = "";
            snap.forEach((child) => {
                const m = child.val();
                msgDiv.innerHTML += `
                    <div class="msg-item">
                        <span><b>${m.user}:</b> ${m.text}</span>
                        <span class="del-msg" onclick="deleteMessage('${child.key}')">Ø­Ø°Ù ğŸ—‘ï¸</span>
                    </div>`;
            });
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if (input.value.trim() !== "" && myRole) {
                chatRef.push({
                    user: myRole,
                    text: input.value
                });
                input.value = "";
            }
        }

        function deleteMessage(key) {
            chatRef.child(key).remove();
        }

        function makeMove(index) {
            gameRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data.winner || data.board[index] !== "" || data.turn !== myRole) return;
                document.getElementById('click-sound').play();
                data.board[index] = myRole;
                const win = checkWinner(data.board);
                if (win) data.winner = win;
                else if (!data.board.includes("")) data.winner = "Draw";
                else data.turn = data.turn === "X" ? "O" : "X";
                gameRef.set(data);
            });
        }

        function checkWinner(board) {
            const patterns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let p of patterns) {
                if (board[p[0]] && board[p[0]] === board[p[1]] && board[p[0]] === board[p[2]]) return board[p[0]];
            }
            return null;
        }

        function resetGame() {
            gameRef.update({
                board: ["", "", "", "", "", "", "", "", ""],
                turn: "X",
                winner: null
            });
        }
    </script>
</body>
</html>
