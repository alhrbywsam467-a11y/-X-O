<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O ÙˆØ³Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --x-color: #fbbf24; --o-color: #f87171; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #status { margin-bottom: 20px; font-size: 1.2rem; padding: 10px 25px; background: var(--card); border-radius: 50px; border: 1px solid #334155; }
        #player-identity { margin-bottom: 10px; color: var(--primary); font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(3, 90px); gap: 12px; }
        .cell { width: 90px; height: 90px; background: var(--card); border: 2px solid #334155; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .cell:hover { border-color: var(--primary); }
        .cell.X { color: var(--x-color); }
        .cell.O { color: var(--o-color); }
        .disabled { pointer-events: none; opacity: 0.7; }
        button { margin-top: 30px; background: var(--primary); color: var(--bg); border: none; padding: 12px 35px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸ® Ù…Ù†ØµØ© ÙˆØ³Ø§Ù… Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨</h1>
    <div id="player-identity">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù‡ÙˆÙŠØªÙƒ...</div>
    <div id="status">Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...</div>
    
    <div class="grid" id="board">
        <div class="cell" onclick="makeMove(0)"></div>
        <div class="cell" onclick="makeMove(1)"></div>
        <div class="cell" onclick="makeMove(2)"></div>
        <div class="cell" onclick="makeMove(3)"></div>
        <div class="cell" onclick="makeMove(4)"></div>
        <div class="cell" onclick="makeMove(5)"></div>
        <div class="cell" onclick="makeMove(6)"></div>
        <div class="cell" onclick="makeMove(7)"></div>
        <div class="cell" onclick="makeMove(8)"></div>
    </div>

    <button onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ”„</button>

    <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="win-sound" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script>
        const firebaseConfig = { databaseURL: "https://xoxo-af105-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const gameRef = db.ref('pro_game');

        let myRole = null; // Ù‡Ù„ Ø£Ù†Ø§ X Ø£Ù… OØŸ

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        gameRef.child('players').once('value').then((snap) => {
            let players = snap.val() || {};
            if (!players.X) {
                myRole = 'X';
                gameRef.child('players/X').set(true);
            } else if (!players.O) {
                myRole = 'O';
                gameRef.child('players/O').set(true);
            } else {
                myRole = 'Viewer'; // Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ø¯Ø¯
            }
            document.getElementById('player-identity').innerText = "Ø£Ù†Øª ØªÙ„Ø¹Ø¨ Ø¨Ù€: " + myRole;
        });

        // Ù…Ø³Ø­ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        window.onbeforeunload = () => { if(myRole) gameRef.child('players/' + myRole).remove(); };

        // 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        gameRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !data.board) { resetGame(); return; }

            const cells = document.querySelectorAll('.cell');
            data.board.forEach((val, i) => {
                cells[i].innerText = val;
                cells[i].className = 'cell ' + (val ? val : '');
            });

            if (data.winner) {
                document.getElementById('status').innerText = data.winner === "Draw" ? "ØªØ¹Ø§Ø¯Ù„! ğŸ¤" : "Ø§Ù„ÙØ§Ø¦Ø²: " + data.winner;
                if(data.winner === myRole) document.getElementById('win-sound').play();
            } else {
                document.getElementById('status').innerText = "Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: " + data.turn;
                
                // Ù‚ÙÙ„ Ø§Ù„Ù„ÙˆØ­Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¯ÙˆØ±Ùƒ
                const boardElement = document.getElementById('board');
                if (data.turn !== myRole) {
                    boardElement.classList.add('disabled');
                } else {
                    boardElement.classList.remove('disabled');
                }
            }
        });

        function makeMove(index) {
            gameRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data.winner || data.board[index] !== "" || data.turn !== myRole) return;

                document.getElementById('click-sound').play();
                data.board[index] = myRole;
                
                const win = checkWinner(data.board);
                if (win) {
                    data.winner = win;
                } else if (!data.board.includes("")) {
                    data.winner = "Draw";
                } else {
                    data.turn = data.turn === "X" ? "O" : "X";
                }
                gameRef.set(data);
            });
        }

        function checkWinner(board) {
            const patterns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let p of patterns) {
                if (board[p[0]] && board[p[0]] === board[p[1]] && board[p[0]] === board[p[2]]) return board[p[0]];
            }
            return null;
        }

        function resetGame() {
            gameRef.update({
                board: ["", "", "", "", "", "", "", "", ""],
                turn: "X",
                winner: null
            });
        }
    </script>
</body>
</html>
